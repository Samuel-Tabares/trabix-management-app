// ===========================================
// TRABIX Backend - Prisma Schema
// Según sección 19 del documento de especificación
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS (Sección 19.1)
// ===========================================

enum Rol {
  ADMIN
  VENDEDOR
  RECLUTADOR
}

enum EstadoUsuario {
  ACTIVO
  INACTIVO
}

enum EstadoLote {
  CREADO
  ACTIVO
  FINALIZADO
}

enum ModeloNegocio {
  MODELO_60_40
  MODELO_50_50
}

enum EstadoTanda {
  INACTIVA
  LIBERADA
  EN_TRANSITO
  EN_CASA
  FINALIZADA
}

enum EstadoVenta {
  PENDIENTE
  APROBADA
  RECHAZADA
}

enum TipoVenta {
  PROMO
  UNIDAD
  SIN_LICOR
  REGALO
}

enum EstadoVentaMayor {
  PENDIENTE
  COMPLETADA
}

enum ModalidadVentaMayor {
  ANTICIPADO
  CONTRAENTREGA
}

enum EstadoCuadre {
  INACTIVO
  PENDIENTE
  EXITOSO
}

enum ConceptoCuadre {
  INVERSION_ADMIN
  GANANCIAS
  MIXTO
}

enum EstadoMiniCuadre {
  INACTIVO
  PENDIENTE
  EXITOSO
}

enum EstadoEquipamiento {
  SOLICITADO
  ACTIVO
  DEVUELTO
  DANADO
  PERDIDO
}

enum TipoTransaccionFondo {
  ENTRADA
  SALIDA
}

enum TipoNotificacion {
  STOCK_BAJO
  CUADRE_PENDIENTE
  INVERSION_RECUPERADA
  CUADRE_EXITOSO
  TANDA_LIBERADA
  MANUAL
  PREMIO_RECIBIDO
}

enum CanalNotificacion {
  WEBSOCKET
  PUSH
  WHATSAPP
}

enum EstadoPedidoStock {
  BORRADOR
  CONFIRMADO
  RECIBIDO
  CANCELADO
}

// ===========================================
// MODELOS (Sección 19.2)
// ===========================================

model Usuario {
  id                      String         @id @default(uuid())
  cedula                  Int            @unique
  nombre                  String
  apellidos               String
  email                   String         @unique
  telefono                String         @unique
  passwordHash            String
  requiereCambioPassword  Boolean        @default(true)
  rol                     Rol            @default(VENDEDOR)
  estado                  EstadoUsuario  @default(ACTIVO)
  
  reclutadorId            String?
  reclutador              Usuario?       @relation("Reclutamiento", fields: [reclutadorId], references: [id])
  reclutados              Usuario[]      @relation("Reclutamiento")
  
  lotes                   Lote[]
  ventas                  Venta[]
  ventasMayor             VentaMayor[]
  equipamiento            Equipamiento?
  notificaciones          Notificacion[]
  historialConfiguraciones HistorialConfiguracion[]
  
  refreshTokenHash        String?
  intentosFallidos        Int            @default(0)
  bloqueadoHasta          DateTime?
  
  fechaCreacion           DateTime       @default(now())
  ultimoLogin             DateTime?
  fechaCambioEstado       DateTime?
  
  eliminado               Boolean        @default(false)
  fechaEliminacion        DateTime?

  @@map("usuarios")
}

model Lote {
  id                  String        @id @default(uuid())
  vendedorId          String
  vendedor            Usuario       @relation(fields: [vendedorId], references: [id])
  
  version             Int           @default(0)
  cantidadTrabix      Int
  modeloNegocio       ModeloNegocio
  estado              EstadoLote    @default(CREADO)
  
  inversionTotal      Decimal       @db.Decimal(12, 2)
  inversionAdmin      Decimal       @db.Decimal(12, 2)
  inversionVendedor   Decimal       @db.Decimal(12, 2)
  dineroRecaudado     Decimal       @default(0) @db.Decimal(12, 2)
  dineroTransferido   Decimal       @default(0) @db.Decimal(12, 2)
  
  esLoteForzado       Boolean       @default(false)
  ventaMayorOrigenId  String?
  ventaMayorOrigen    VentaMayor?   @relation(fields: [ventaMayorOrigenId], references: [id])
  
  tandas              Tanda[]
  ventas              Venta[]
  miniCuadre          MiniCuadre?
  
  fechaCreacion       DateTime      @default(now())
  fechaActivacion     DateTime?
  fechaFinalizacion   DateTime?

  @@index([vendedorId, estado])
  @@index([estado, fechaCreacion])
  @@map("lotes")
}

model Tanda {
  id                        String       @id @default(uuid())
  loteId                    String
  lote                      Lote         @relation(fields: [loteId], references: [id])
  
  version                   Int          @default(0)
  numero                    Int
  estado                    EstadoTanda  @default(INACTIVA)
  
  stockInicial              Int
  stockActual               Int
  stockConsumidoPorMayor    Int          @default(0)
  
  liberadaPorCuadreMayorId  String?
  
  cuadre                    Cuadre?
  ventas                    Venta[]
  
  fechaLiberacion           DateTime?
  fechaEnTransito           DateTime?
  fechaEnCasa               DateTime?
  fechaFinalizada           DateTime?

  @@index([loteId, estado])
  @@index([estado])
  @@map("tandas")
}

model Venta {
  id              String       @id @default(uuid())
  vendedorId      String
  vendedor        Usuario      @relation(fields: [vendedorId], references: [id])
  
  loteId          String
  lote            Lote         @relation(fields: [loteId], references: [id])
  
  tandaId         String
  tanda           Tanda        @relation(fields: [tandaId], references: [id])
  
  estado          EstadoVenta  @default(PENDIENTE)
  detalles        DetalleVenta[]
  
  montoTotal      Decimal      @db.Decimal(12, 2)
  cantidadTrabix  Int
  
  fechaRegistro   DateTime     @default(now())
  fechaValidacion DateTime?

  @@index([vendedorId, estado])
  @@index([loteId, tandaId])
  @@index([fechaRegistro])
  @@map("ventas")
}

model DetalleVenta {
  id             String    @id @default(uuid())
  ventaId        String
  venta          Venta     @relation(fields: [ventaId], references: [id])
  
  tipo           TipoVenta
  cantidad       Int
  precioUnitario Decimal   @db.Decimal(12, 2)
  subtotal       Decimal   @db.Decimal(12, 2)

  @@map("detalles_venta")
}

model VentaMayor {
  id               String              @id @default(uuid())
  vendedorId       String
  vendedor         Usuario             @relation(fields: [vendedorId], references: [id])
  
  cantidadUnidades Int
  precioUnidad     Decimal             @db.Decimal(12, 2)
  ingresoBruto     Decimal             @db.Decimal(12, 2)
  conLicor         Boolean             @default(true)
  
  modalidad        ModalidadVentaMayor
  estado           EstadoVentaMayor    @default(PENDIENTE)
  
  fuentesStock     FuenteStockMayor[]
  lotesInvolucrados LoteVentaMayor[]
  loteForzado      Lote[]
  cuadreMayor      CuadreMayor?
  
  fechaRegistro    DateTime            @default(now())
  fechaCompletada  DateTime?

  @@map("ventas_mayor")
}

model FuenteStockMayor {
  id               String     @id @default(uuid())
  ventaMayorId     String
  ventaMayor       VentaMayor @relation(fields: [ventaMayorId], references: [id])
  
  tandaId          String
  cantidadConsumida Int
  tipoStock        String     // RESERVADO | EN_CASA | LOTE_FORZADO

  @@map("fuentes_stock_mayor")
}

model LoteVentaMayor {
  id           String     @id @default(uuid())
  ventaMayorId String
  ventaMayor   VentaMayor @relation(fields: [ventaMayorId], references: [id])
  
  loteId       String

  @@map("lotes_venta_mayor")
}

model Cuadre {
  id                     String         @id @default(uuid())
  tandaId                String         @unique
  tanda                  Tanda          @relation(fields: [tandaId], references: [id])
  
  version                Int            @default(0)
  estado                 EstadoCuadre   @default(INACTIVO)
  concepto               ConceptoCuadre
  
  montoEsperado          Decimal        @db.Decimal(12, 2)
  montoRecibido          Decimal        @default(0) @db.Decimal(12, 2)
  montoFaltante          Decimal        @default(0) @db.Decimal(12, 2)
  montoCubiertoPorMayor  Decimal        @default(0) @db.Decimal(12, 2)
  
  cerradoPorCuadreMayorId String?
  
  fechaPendiente         DateTime?
  fechaExitoso           DateTime?

  @@index([estado])
  @@map("cuadres")
}

model CuadreMayor {
  id                              String              @id @default(uuid())
  ventaMayorId                    String              @unique
  ventaMayor                      VentaMayor          @relation(fields: [ventaMayorId], references: [id])
  
  vendedorId                      String
  modalidad                       ModalidadVentaMayor
  estado                          EstadoCuadre        @default(PENDIENTE)
  
  // Campos del registro (7.6)
  cantidadUnidades                Int
  precioUnidad                    Decimal             @db.Decimal(12, 2)
  ingresoBruto                    Decimal             @db.Decimal(12, 2)
  
  // Desglose de dinero (7.6)
  deudasSaldadas                  Decimal             @default(0) @db.Decimal(12, 2)
  inversionAdminLotesExistentes   Decimal             @db.Decimal(12, 2)
  inversionAdminLoteForzado       Decimal             @default(0) @db.Decimal(12, 2)
  inversionVendedorLotesExistentes Decimal            @db.Decimal(12, 2)
  inversionVendedorLoteForzado    Decimal             @default(0) @db.Decimal(12, 2)
  gananciasAdmin                  Decimal             @default(0) @db.Decimal(12, 2)
  gananciasVendedor               Decimal             @default(0) @db.Decimal(12, 2)
  
  // Evaluación financiera completa (8.3)
  evaluacionFinanciera            Json
  
  // Totales
  montoTotalAdmin                 Decimal             @db.Decimal(12, 2)
  montoTotalVendedor              Decimal             @db.Decimal(12, 2)
  
  // Referencias
  lotesInvolucradosIds            String[]
  tandasAfectadas                 Json
  cuadresCerradosIds              String[]
  loteForzadoId                   String?
  
  gananciasReclutadores           GananciaReclutador[]
  
  fechaRegistro                   DateTime            @default(now())
  fechaExitoso                    DateTime?

  @@index([estado])
  @@map("cuadres_mayor")
}

model MiniCuadre {
  id             String          @id @default(uuid())
  loteId         String          @unique
  lote           Lote            @relation(fields: [loteId], references: [id])
  
  tandaId        String
  estado         EstadoMiniCuadre @default(INACTIVO)
  montoFinal     Decimal         @default(0) @db.Decimal(12, 2)
  
  fechaPendiente DateTime?
  fechaExitoso   DateTime?

  @@map("mini_cuadres")
}

model Equipamiento {
  id                     String             @id @default(uuid())
  vendedorId             String             @unique
  vendedor               Usuario            @relation(fields: [vendedorId], references: [id])
  
  estado                 EstadoEquipamiento @default(SOLICITADO)
  tieneDeposito          Boolean            @default(false)
  depositoPagado         Decimal?           @db.Decimal(12, 2)
  mensualidadActual      Decimal            @db.Decimal(12, 2)
  
  ultimaMensualidadPagada DateTime?
  deudaDano              Decimal            @default(0) @db.Decimal(12, 2)
  deudaPerdida           Decimal            @default(0) @db.Decimal(12, 2)
  
  fechaSolicitud         DateTime           @default(now())
  fechaEntrega           DateTime?
  fechaDevolucion        DateTime?
  
  depositoDevuelto       Boolean            @default(false)
  fechaDevolucionDeposito DateTime?

  @@map("equipamientos")
}

model PedidoStock {
  id                 String            @id @default(uuid())
  cantidadTrabix     Int
  estado             EstadoPedidoStock @default(BORRADOR)
  
  costoTotal         Decimal           @default(0) @db.Decimal(12, 2)
  costoRealPorTrabix Decimal           @default(0) @db.Decimal(12, 2)
  
  detallesCosto      DetalleCostoPedido[]
  
  fechaCreacion      DateTime          @default(now())
  fechaRecepcion     DateTime?
  fechaCancelacion   DateTime?
  motivoCancelacion  String?
  notas              String?

  @@index([estado])
  @@index([fechaCreacion])
  @@map("pedidos_stock")
}

model DetalleCostoPedido {
  id            String      @id @default(uuid())
  pedidoId      String
  pedido        PedidoStock @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  
  concepto      String
  esObligatorio Boolean     @default(false)
  cantidad      Int?
  costoTotal    Decimal     @db.Decimal(12, 2)
  
  fechaRegistro DateTime    @default(now())

  @@index([pedidoId])
  @@map("detalles_costo_pedido")
}

model TipoInsumo {
  id            String   @id @default(uuid())
  nombre        String   @unique
  esObligatorio Boolean  @default(false)
  activo        Boolean  @default(true)
  
  fechaCreacion DateTime @default(now())

  @@map("tipos_insumo")
}

model ConfiguracionSistema {
  id                String   @id @default(uuid())
  clave             String   @unique
  valor             String
  tipo              String   // DECIMAL | INT | PERCENT
  descripcion       String
  categoria         String   // PRECIOS | PORCENTAJES | EQUIPAMIENTO | TIEMPOS
  modificable       Boolean  @default(true)
  
  ultimaModificacion DateTime @default(now())
  modificadoPorId   String?

  @@index([categoria])
  @@index([clave])
  @@map("configuraciones_sistema")
}

model HistorialConfiguracion {
  id              String   @id @default(uuid())
  clave           String
  valorAnterior   String
  valorNuevo      String
  modificadoPorId String
  modificadoPor   Usuario  @relation(fields: [modificadoPorId], references: [id])
  motivo          String?
  
  fechaCambio     DateTime @default(now())

  @@index([clave])
  @@index([fechaCambio])
  @@map("historial_configuraciones")
}

model StockAdmin {
  id                  String   @id @default(uuid())
  stockFisico         Int      @default(0)
  ultimoPedidoId      String?
  
  ultimaActualizacion DateTime @default(now())

  @@map("stock_admin")
}

model TransaccionFondo {
  id               String               @id @default(uuid())
  tipo             TipoTransaccionFondo
  monto            Decimal              @db.Decimal(12, 2)
  motivo           String?
  loteOrigenId     String?
  
  fechaTransaccion DateTime             @default(now())

  @@map("transacciones_fondo")
}

model Notificacion {
  id            String            @id @default(uuid())
  usuarioId     String
  usuario       Usuario           @relation(fields: [usuarioId], references: [id])
  
  tipo          TipoNotificacion
  titulo        String
  mensaje       String
  datos         Json?
  canal         CanalNotificacion @default(WEBSOCKET)
  
  leida         Boolean           @default(false)
  fechaCreacion DateTime          @default(now())
  fechaLeida    DateTime?

  @@map("notificaciones")
}

model AuditLog {
  id              String   @id @default(uuid())
  usuarioId       String?
  accion          String
  entidad         String
  entidadId       String?
  datosAnteriores Json?
  datosNuevos     Json?
  ip              String?
  userAgent       String?
  
  fechaCreacion   DateTime @default(now())

  @@map("audit_logs")
}

model GananciaReclutador {
  id               String      @id @default(uuid())
  cuadreMayorId    String
  cuadreMayor      CuadreMayor @relation(fields: [cuadreMayorId], references: [id])
  
  reclutadorId     String
  nivel            Int
  monto            Decimal     @db.Decimal(12, 2)
  
  transferido      Boolean     @default(false)
  fechaTransferencia DateTime?

  @@index([cuadreMayorId])
  @@index([reclutadorId])
  @@map("ganancias_reclutadores")
}

model EventStore {
  id            String   @id @default(uuid())
  eventName     String
  aggregateType String
  aggregateId   String
  payload       Json
  metadata      Json?
  
  occurredOn    DateTime @default(now())

  @@index([aggregateType, aggregateId])
  @@index([eventName, occurredOn])
  @@map("event_store")
}

model Outbox {
  id          String    @id @default(uuid())
  eventType   String
  payload     Json
  
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  error       String?
  retries     Int       @default(0)

  @@index([processedAt, createdAt])
  @@map("outbox")
}

model TokenBlacklist {
  id        String   @id @default(uuid())
  tokenId   String   @unique
  expiresAt DateTime
  
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("token_blacklist")
}

model IdempotencyKey {
  id         String   @id @default(uuid())
  key        String   @unique
  endpoint   String
  response   Json
  statusCode Int
  
  createdAt  DateTime @default(now())
  expiresAt  DateTime

  @@index([expiresAt])
  @@map("idempotency_keys")
}

// ========== Fondo de Recompensas ==========

model MovimientoFondo {
  id               String   @id @default(uuid())
  
  tipo             String   // ENTRADA | SALIDA
  monto            Decimal  @db.Decimal(12, 2)
  concepto         String
  loteId           String?  // Solo para entradas (referencia al lote)
  vendedorBeneficiarioId String?
  
  fechaTransaccion DateTime @default(now())

  @@index([tipo, fechaTransaccion])
  @@index([vendedorBeneficiarioId])
  @@map("movimientos_fondo")
}

