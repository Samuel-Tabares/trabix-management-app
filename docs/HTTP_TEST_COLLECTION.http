# Colección de Pruebas HTTP - TRABIX Backend
# Compatible con: REST Client (VS Code), Insomnia, Postman, curl

# Variables globales - ACTUALIZAR después de cada login
@baseUrl = http://localhost:3000/api/v1
@adminToken = {{login_admin_response.body.accessToken}}
@vendedorToken = {{login_vendedor_response.body.accessToken}}

###############################################################################
# FASE 1: AUTENTICACIÓN
###############################################################################

### A1.1 - Login Admin (exitoso)
# @name login_admin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "cedula": "ADMIN001",
  "password": "Admin123!"
}

### A1.2 - Login Vendedor 60/40
# @name login_vendedor_6040
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "cedula": "1234567890",
  "password": "Temporal123!"
}

### A1.3 - Login con credenciales inválidas (debe fallar 401)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "cedula": "NOEXISTE",
  "password": "wrongpassword"
}

### A1.5 - Login vendedor INACTIVO (debe fallar)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "cedula": "8888888888",
  "password": "Temporal123!"
}

### A1.6 - Login vendedor que debe cambiar password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "cedula": "7777777777",
  "password": "Temporal123!"
}

### A2.1 - Refresh Token
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{login_admin_response.body.refreshToken}}"
}

### A3.1 - Logout
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{adminToken}}

### A4.1 - Cambiar Password
POST {{baseUrl}}/auth/cambiar-password
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json

{
  "passwordActual": "Temporal123!",
  "passwordNuevo": "NuevoPassword123!"
}

###############################################################################
# FASE 2: USUARIOS
###############################################################################

### U1.1 - Crear vendedor modelo 60/40 (directo de admin)
POST {{baseUrl}}/usuarios
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "cedula": "9999999999",
  "nombre": "Nuevo",
  "apellidos": "Vendedor Prueba",
  "email": "nuevo.vendedor@test.com",
  "telefono": "3209999999",
  "direccion": "Dirección de prueba"
}

### U1.2 - Crear vendedor modelo 50/50 (bajo reclutador)
POST {{baseUrl}}/usuarios
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "cedula": "1010101010",
  "nombre": "Otro",
  "apellidos": "Vendedor Reclutado",
  "email": "otro.reclutado@test.com",
  "telefono": "3101010101",
  "direccion": "Dirección reclutado",
  "reclutadorId": "{{id_reclutador}}"
}

### U2.1 - Listar todos los usuarios (admin)
GET {{baseUrl}}/usuarios
Authorization: Bearer {{adminToken}}

### U2.2 - Listar solo vendedores
GET {{baseUrl}}/usuarios?rol=VENDEDOR
Authorization: Bearer {{adminToken}}

### U2.3 - Listar solo activos
GET {{baseUrl}}/usuarios?estado=ACTIVO
Authorization: Bearer {{adminToken}}

### U2.4 - Obtener mi perfil (vendedor)
GET {{baseUrl}}/usuarios/me
Authorization: Bearer {{vendedorToken}}

### U4.1 - Ver cadena de reclutamiento
GET {{baseUrl}}/usuarios/{{vendedorId}}/cadena-reclutamiento
Authorization: Bearer {{adminToken}}

### U4.2 - Ver reclutados directos
GET {{baseUrl}}/usuarios/{{reclutadorId}}/reclutados
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 3: LOTES
###############################################################################

### L1.1 - Crear lote de 50 TRABIX (2 tandas)
POST {{baseUrl}}/lotes
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "vendedorId": "{{vendedor6040Id}}",
  "cantidadTrabix": 50
}

### L1.2 - Crear lote de 100 TRABIX (3 tandas)
POST {{baseUrl}}/lotes
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "vendedorId": "{{vendedor6040Id}}",
  "cantidadTrabix": 100
}

### L2.1 - Activar lote (confirmar inversión vendedor)
POST {{baseUrl}}/lotes/{{loteId}}/activar
Authorization: Bearer {{adminToken}}

### L3.1 - Listar mis lotes (vendedor)
GET {{baseUrl}}/lotes/mis-lotes
Authorization: Bearer {{vendedorToken}}

### L3.2 - Listar todos los lotes (admin)
GET {{baseUrl}}/lotes
Authorization: Bearer {{adminToken}}

### L3.3 - Filtrar por estado
GET {{baseUrl}}/lotes?estado=ACTIVO
Authorization: Bearer {{adminToken}}

### L3.4 - Obtener detalle con tandas
GET {{baseUrl}}/lotes/{{loteId}}
Authorization: Bearer {{adminToken}}

### L3.5 - Ver resumen financiero del lote
GET {{baseUrl}}/lotes/{{loteId}}/resumen-financiero
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 4: TANDAS
###############################################################################

### T1.3 - Marcar tanda EN_TRÁNSITO → EN_CASA
POST {{baseUrl}}/tandas/{{tandaId}}/marcar-en-casa
Authorization: Bearer {{adminToken}}

### T2 - Listar tandas de un lote
GET {{baseUrl}}/lotes/{{loteId}}/tandas
Authorization: Bearer {{adminToken}}

### T3 - Obtener detalle de tanda
GET {{baseUrl}}/tandas/{{tandaId}}
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 5: VENTAS AL DETAL
###############################################################################

### V1.1 - Registrar venta simple (5 unidades)
POST {{baseUrl}}/ventas
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json
X-Idempotency-Key: venta-test-001

{
  "detalle": [
    { "tipo": "UNIDAD", "cantidad": 5 }
  ]
}

### V1.2 - Registrar venta promo (2 promos = 4 unidades)
POST {{baseUrl}}/ventas
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json
X-Idempotency-Key: venta-test-002

{
  "detalle": [
    { "tipo": "PROMO", "cantidad": 2 }
  ]
}

### V1.5 - Registrar venta mixta
POST {{baseUrl}}/ventas
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json
X-Idempotency-Key: venta-test-003

{
  "detalle": [
    { "tipo": "PROMO", "cantidad": 2 },
    { "tipo": "UNIDAD", "cantidad": 3 },
    { "tipo": "REGALO", "cantidad": 1 },
    { "tipo": "SIN_LICOR", "cantidad": 2 }
  ]
}

### V2.1 - Aprobar venta (admin)
POST {{baseUrl}}/ventas/{{ventaId}}/aprobar
Authorization: Bearer {{adminToken}}

### V2.2 - Rechazar venta (admin)
POST {{baseUrl}}/ventas/{{ventaId}}/rechazar
Authorization: Bearer {{adminToken}}

### V - Listar mis ventas (vendedor)
GET {{baseUrl}}/ventas/mis-ventas
Authorization: Bearer {{vendedorToken}}

### V - Listar todas las ventas (admin)
GET {{baseUrl}}/ventas
Authorization: Bearer {{adminToken}}

### V - Ventas pendientes de aprobar
GET {{baseUrl}}/ventas?estado=PENDIENTE
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 6: CUADRES NORMALES
###############################################################################

### C - Listar cuadres de un lote
GET {{baseUrl}}/cuadres?loteId={{loteId}}
Authorization: Bearer {{adminToken}}

### C - Obtener cuadre específico
GET {{baseUrl}}/cuadres/{{cuadreId}}
Authorization: Bearer {{adminToken}}

### C2.1 - Confirmar cuadre (admin)
POST {{baseUrl}}/cuadres/{{cuadreId}}/confirmar
Authorization: Bearer {{adminToken}}
Content-Type: application/json
X-Idempotency-Key: cuadre-confirm-001

{
  "montoRecibido": 120000
}

### C - Cuadres pendientes
GET {{baseUrl}}/cuadres?estado=PENDIENTE
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 7: MINI-CUADRES
###############################################################################

### M - Listar mini-cuadres
GET {{baseUrl}}/mini-cuadres
Authorization: Bearer {{adminToken}}

### M - Obtener mini-cuadre de un lote
GET {{baseUrl}}/mini-cuadres?loteId={{loteId}}
Authorization: Bearer {{adminToken}}

### M2.1 - Confirmar mini-cuadre
POST {{baseUrl}}/mini-cuadres/{{miniCuadreId}}/confirmar
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "montoRecibido": 0
}

###############################################################################
# FASE 8: VENTAS AL MAYOR
###############################################################################

### VM1.1 - Registrar venta al mayor (mínimo 21)
POST {{baseUrl}}/ventas-mayor
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json

{
  "cantidadUnidades": 50,
  "precioUnidad": 6500,
  "modalidad": "ANTICIPADO"
}

### VM1.4 - Venta mayor contraentrega
POST {{baseUrl}}/ventas-mayor
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json

{
  "cantidadUnidades": 30,
  "precioUnidad": 6500,
  "modalidad": "CONTRAENTREGA"
}

### VM - Listar ventas al mayor
GET {{baseUrl}}/ventas-mayor
Authorization: Bearer {{adminToken}}

### VM - Obtener detalle venta mayor
GET {{baseUrl}}/ventas-mayor/{{ventaMayorId}}
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 9: CUADRES AL MAYOR
###############################################################################

### CM - Listar cuadres al mayor
GET {{baseUrl}}/cuadres-mayor
Authorization: Bearer {{adminToken}}

### CM - Obtener cuadre mayor específico
GET {{baseUrl}}/cuadres-mayor/{{cuadreMayorId}}
Authorization: Bearer {{adminToken}}

### CM3.1 - Confirmar cuadre mayor
POST {{baseUrl}}/cuadres-mayor/{{cuadreMayorId}}/confirmar
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "montoRecibido": 325000
}

###############################################################################
# FASE 10: EQUIPAMIENTO
###############################################################################

### E1.1 - Solicitar equipamiento con depósito
POST {{baseUrl}}/equipamiento/solicitar
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json

{
  "tieneDeposito": true
}

### E1.2 - Solicitar equipamiento sin depósito
POST {{baseUrl}}/equipamiento/solicitar
Authorization: Bearer {{vendedorToken}}
Content-Type: application/json

{
  "tieneDeposito": false
}

### E2.1 - Activar equipamiento (admin)
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/activar
Authorization: Bearer {{adminToken}}

### E3.1 - Pagar mensualidad
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/pagar-mensualidad
Authorization: Bearer {{adminToken}}
X-Idempotency-Key: mensualidad-001

### E4.1 - Reportar daño nevera
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/reportar-dano
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "tipoDano": "NEVERA"
}

### E4.2 - Reportar daño pijama
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/reportar-dano
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "tipoDano": "PIJAMA"
}

### E4.3 - Pagar daño
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/pagar-dano
Authorization: Bearer {{adminToken}}

### E5.1 - Reportar pérdida
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/reportar-perdida
Authorization: Bearer {{adminToken}}

### E6.1 - Devolver equipamiento
POST {{baseUrl}}/equipamiento/{{equipamientoId}}/devolver
Authorization: Bearer {{adminToken}}

### E - Ver mi equipamiento (vendedor)
GET {{baseUrl}}/equipamiento/mi-equipamiento
Authorization: Bearer {{vendedorToken}}

### E - Listar todos los equipamientos (admin)
GET {{baseUrl}}/equipamiento
Authorization: Bearer {{adminToken}}

###############################################################################
# FASE 11: FONDO DE RECOMPENSAS
###############################################################################

### F3.1 - Obtener saldo del fondo
GET {{baseUrl}}/fondo-recompensas/saldo
Authorization: Bearer {{adminToken}}

### F3.2 - Listar transacciones
GET {{baseUrl}}/fondo-recompensas/transacciones
Authorization: Bearer {{adminToken}}

### F2.1 - Registrar salida del fondo
POST {{baseUrl}}/fondo-recompensas/salida
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "monto": 50000,
  "concepto": "Premio vendedor del mes - Enero 2026"
}

###############################################################################
# FASE 12: ADMIN
###############################################################################

### AD1.1 - Ver stock admin
GET {{baseUrl}}/admin/stock
Authorization: Bearer {{adminToken}}

### AD1.3 - Ver déficit
GET {{baseUrl}}/admin/stock/deficit
Authorization: Bearer {{adminToken}}

### AD2.1 - Crear pedido de stock (borrador)
POST {{baseUrl}}/admin/pedidos-stock
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "cantidadTrabix": 500,
  "notas": "Pedido de prueba"
}

### AD2.2 - Agregar costo al pedido
POST {{baseUrl}}/admin/pedidos-stock/{{pedidoId}}/costos
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "concepto": "TRABIX (granizado)",
  "esObligatorio": true,
  "cantidad": 500,
  "costoTotal": 500000
}

### AD2.5 - Confirmar pedido
POST {{baseUrl}}/admin/pedidos-stock/{{pedidoId}}/confirmar
Authorization: Bearer {{adminToken}}

### AD2.6 - Recibir pedido
POST {{baseUrl}}/admin/pedidos-stock/{{pedidoId}}/recibir
Authorization: Bearer {{adminToken}}

### AD3.1 - Listar configuraciones
GET {{baseUrl}}/admin/configuraciones
Authorization: Bearer {{adminToken}}

### AD3.2 - Modificar configuración
PATCH {{baseUrl}}/admin/configuraciones/PRECIO_UNIDAD
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "valor": "8500",
  "motivo": "Ajuste por inflación"
}

### AD3.4 - Ver historial de cambios
GET {{baseUrl}}/admin/configuraciones/historial?clave=PRECIO_UNIDAD
Authorization: Bearer {{adminToken}}

### AD4.1 - Listar tipos de insumo
GET {{baseUrl}}/admin/tipos-insumo
Authorization: Bearer {{adminToken}}

### AD5.1 - Dashboard resumen
GET {{baseUrl}}/admin/dashboard/resumen
Authorization: Bearer {{adminToken}}

### AD5.2 - Ventas por período
GET {{baseUrl}}/admin/dashboard/ventas?periodo=semana
Authorization: Bearer {{adminToken}}

### AD5.3 - Cuadres pendientes
GET {{baseUrl}}/admin/dashboard/cuadres-pendientes
Authorization: Bearer {{adminToken}}

###############################################################################
# HEALTH CHECK
###############################################################################

### Health check básico
GET {{baseUrl}}/health

### Health check detallado
GET {{baseUrl}}/health/detailed
